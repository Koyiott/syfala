<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Embedded Linux - Syfala Documentation</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Syfala Documentation</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Manual <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../manual/manual/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../manual/dependencies/" class="dropdown-item">Dependencies</a>
</li>
                                    
<li>
    <a href="../../manual/reference/" class="dropdown-item">Reference</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../faust-getting-started/" class="dropdown-item">Faust tutorial</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Embedded Linux</a>
</li>
                                    
<li>
    <a href="../cpp-tutorial-advanced/" class="dropdown-item">C++ tutorial</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../faust-getting-started/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../cpp-tutorial-advanced/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-light">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#syfala-linux-getting-started" class="nav-link">syfala-linux getting started</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#requirements" class="nav-link">Requirements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#building" class="nav-link">Building</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#available-commands" class="nav-link">Available commands</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="4"><a href="#from-scratch" class="nav-link">From scratch</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#outputs" class="nav-link">Outputs</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#usage" class="nav-link">Usage</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#formatting-the-sd-card" class="nav-link">Formatting the SD card</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#flashing-boot-root-partitions" class="nav-link">Flashing boot &amp; root partitions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#booting" class="nav-link">Booting</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#connecting" class="nav-link">Connecting</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#loginusers" class="nav-link">Login/users</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#faust-dsp-builds" class="nav-link">Faust DSP builds</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#getting-the-devices-ip-port-from-avahi-for-network-based-control" class="nav-link">Getting the device's IP &amp; port from avahi (for network-based control)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#http-control" class="nav-link">HTTP control</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#osc-control" class="nav-link">OSC control</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#midi-control" class="nav-link">MIDI control</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#wi-fi" class="nav-link">Wi-Fi</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#autologin-autostart-dsp-target" class="nav-link">Autologin / Autostart DSP target</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="syfala-linux-getting-started">syfala-linux getting started</h1>
<h2 id="requirements">Requirements</h2>
<ul>
<li><strong>Xilinx toolchain</strong> version <strong>2022.2</strong></li>
<li>for <em>gcc-compatibility</em> reasons</li>
<li><code>arm-none-eabi-gcc</code> <strong>cross-compilation toolchain</strong></li>
<li>An available <strong>SD card</strong></li>
<li>The following <strong>Linux packages</strong> installed on your machine: </li>
<li><code>bison flex libssl-dev bc u-boot-tools cpio libyaml-dev curl kmod squashfs-tools qemu-user-static</code></li>
</ul>
<h2 id="building">Building</h2>
<h3 id="available-commands">Available commands</h3>
<h4 id="from-scratch">From scratch</h4>
<p><strong>First</strong>, a regular <strong>syfala project</strong> has to be built with the following options: </p>
<pre><code class="language-shell">syfala examples/virtualAnalog.dsp --linux
</code></pre>
<p>The <code>--linux</code> option is used for <strong>compiling the host-side</strong> (<strong>ARM</strong>) <strong>application</strong> with the <strong>linux-specific source files</strong> (otherwise, it would be compiling the standard baremetal one).</p>
<p>After <strong>synthesis</strong>, the script will detect that you don't currently have a linux build, which is required for building the application, and will download and build everything for you, you'll just have to flash it to your formatted SD card afterwards</p>
<h3 id="outputs">Outputs</h3>
<p>The build outputs are located in the<code>build-linux/output</code> directory, with two distinct <code>boot</code> and <code>root</code> subdirectories, which then will have to be be flashed on the first and second partitions of your SD card. </p>
<h2 id="usage">Usage</h2>
<h3 id="formatting-the-sd-card">Formatting the SD card</h3>
<p>The <strong>SD card</strong> has to be formatted like so:</p>
<ul>
<li><strong>1st</strong> partition: <strong>FAT32</strong></li>
<li><strong>2nd</strong> partition: <strong>ext4</strong> (Linux filesystem)</li>
</ul>
<p>There are many ways to achieve this, for instance:</p>
<pre><code class="language-shell"># you can just replace &lt;/dev/...&gt; with your SD device, e.g: /dev/sda or /dev/mmcblk0
sudo parted /dev/... --script -- mklabel msdos
sudo parted /dev/... --script -- mkpart primary fat32 1MiB 128MiB
sudo parted /dev/... --script -- mkpart primary ext4 128MiB 100%
sudo parted /dev/... --script -- set 1 boot on
sudo parted /dev/... --script -- set 1 lba on
sudo mkfs.vfat /dev/device-partition-1 # e.g. /dev/sda1
sudo mkfs.ext4 /dev/device-partition-2 # e.g. /dev/sda2
sudo parted /dev/... --script print
</code></pre>
<h3 id="flashing-boot-root-partitions">Flashing boot &amp; root partitions</h3>
<pre><code class="language-shell"># In case your SD device is /dev/sda
# 1. Copying boot partition files
sudo mount /dev/sda1 /mnt
sudo cp -r build-linux/output/boot/* /mnt
sync
sudo umount /mnt
# 2. Copying root partition contents
sudo mount /dev/sda2 /mnt
sudo cp -r build-linux/output/root/* /mnt
# This might take a while...
sync 
sudo umount /mnt
</code></pre>
<h3 id="booting">Booting</h3>
<p>Once flashed, just insert the SD card in your device's socket, <strong>make also sure it is configured to boot on SD</strong> (For the <strong>Zybo</strong> boards, you'll have to place a <strong>shorting jumper on SD</strong> instead of <em>JTAG</em>/<em>QSPI</em>).</p>
<h3 id="connecting">Connecting</h3>
<p>You can still connect through the <em>ttyUSB</em> <strong>Serial Port</strong>, or with <strong>SSH</strong>.</p>
<ul>
<li>for <strong>Serial Port</strong> connection, check that devices <code>/dev/ttyUSB0</code>and <code>/dev/ttyUSB1</code>are present on your host and use a serial communication program with following configuration: device <code>/dev/ttyUSB1</code>, 115200 8N1 (115200 bits/second, one start bit, eight (8) data bits, no (N) parity bit, and one (1) stop bit), no hardware flow control and no software flow control. If hardware flow control is enable, the serial connection will not behave properly. for instance when using minicom: </li>
</ul>
<pre><code class="language-shell">minicom -b 115200 -D/dev/ttyUSB1 -8
</code></pre>
<p>(check hardware flow control in minicom, ctrl-A Z). Linux booting console will appear. A login prompt will appear as soon as the booting process has completed:</p>
<pre><code class="language-shell">Welcome to Alpine Linux 3.17
Kernel 5.15.0-xilinx on an armv7l (/dev/ttyPS0)

syfala login: 
</code></pre>
<ul>
<li>for  <strong>SSH</strong> connection, make sure that you are connected on the same network as your device's, get its IP address by serial connection as explained above and log as root:</li>
</ul>
<pre><code class="language-shell">ssh root@192.168.0.1 . 
</code></pre>
<h3 id="loginusers">Login/users</h3>
<p>The rootfs has the same structure as any Linux build. The scripts adds a <strong>default user named syfala</strong>, which has its <em>home</em> directory in <em>/home/syfala</em>.</p>
<ul>
<li>The password required to <strong>login as root</strong> is <em>syfala</em></li>
<li>The password required to <strong>login as syfala</strong> is <em>syfala</em></li>
</ul>
<h3 id="faust-dsp-builds">Faust DSP builds</h3>
<p>All the <strong>DSP builds</strong> made with the <strong>syfala toolchain</strong> are placed in the <em>/home/syfala</em> directory by default. For instance, if you make a build from the <strong>virtualAnalog.dsp</strong> file , the <em>bitstream</em>/<em>application</em> outputs will be located in: </p>
<ul>
<li><em>/home/syfala/virtualAnalog/bitstream.bin</em></li>
<li><em>/home/syfala/virtualAnalog/application.elf</em></li>
</ul>
<p>You can then use the </p>
<pre><code class="language-shell">syfala-load &lt;target&gt; [--list | --help]
</code></pre>
<p>utility command (e.g. <code>syfala-load virtualAnalog</code>), which will take care of <strong>loading the bitstream</strong> and <strong>executing the app</strong> properly.</p>
<p>You can also do all of that manually of course: first, <strong>load the bitstream</strong> by entering the following command line:</p>
<pre><code class="language-shell">fpgautil -b /home/syfala/virtualAnalog/bitstream.bin
</code></pre>
<p>and then <strong>execute the Host application</strong> like you would normally do with a Linux binary:</p>
<pre><code class="language-shell">cd /home/syfala/virtualAnalog
./application.elf     
</code></pre>
<p>If you wish to <strong>add another build</strong> to the SD card, you just have to re-run the syfala toolchain normally on your computer, with the <code>--linux</code> option. <strong>Your previous builds won't be erased or modified.</strong></p>
<pre><code class="language-shell">syfala examples/fm.dsp --linux
</code></pre>
<p>Once the build is complete,  you will have two distinct project directories in your<code>build-linux/output/root/home/syfala</code> directory:</p>
<ul>
<li><code>/home/syfala/virtualAnalog</code></li>
<li><code>/home/syfala/fm</code></li>
</ul>
<p>You will then have to <strong>re-flash your SD card</strong> to <strong>update the root partition</strong>, or directly copy the directory through <strong>ssh</strong> (e.g. with the <code>scp</code> command).</p>
<h3 id="getting-the-devices-ip-port-from-avahi-for-network-based-control">Getting the device's IP &amp; port from avahi (for network-based control)</h3>
<p>Once a DSP target is loaded with the <code>syfala-load</code> command, an <strong>avahi service</strong> is automatically started in a separate thread. If your desktop machine is on the same network as the FPGA board, and you have <strong>avahi</strong> installed &amp; running, you should be able to <strong>retrieve the FPGA board's IP address and port</strong> required for the HTTP/OSC controls. You can use the <code>avahi-browse</code> command in order to do so:</p>
<pre><code class="language-shell">avahi-browse _syfala._tcp --resolve
</code></pre>
<h3 id="http-control">HTTP control</h3>
<p>In order to build a target with <strong>HTTP support</strong>, you can add the <code>--http</code> flag to the command line:</p>
<pre><code class="language-shell">syfala examples/fm.dsp --linux --http
</code></pre>
<p>After loading a DSP target with the <code>syfala-load</code> command (or manually), the host application <strong>will create a HTTP server</strong> allowing users to <strong>control the Faust DSP parameters remotely</strong> (given that you are on the same network as your FPGA board).</p>
<p>At runtime, when executed, the <strong>application will print the device's current network IP</strong> (IPv4), and the <strong>port</strong> used by the HTTP server. You can then <strong>use any web browser</strong>, and control the application by entering the server's URL, for example <em>http://192.168.0.1:5510</em></p>
<h3 id="osc-control">OSC control</h3>
<p>In order to build a target with <strong>OSC support</strong>, you can add the <code>--osc</code> flag to the command line:</p>
<pre><code class="language-shell">syfala examples/fm.dsp --linux --osc
</code></pre>
<p><strong>Note:</strong> your Faust <strong>.dsp file must also contain this line</strong> in order to enable OSC support:</p>
<pre><code class="language-faust">declare options &quot;[osc:on]&quot;;
</code></pre>
<p>In parallel, the Host application will also create an <strong>Open Sound Control-compliant UDP server</strong>, and <strong>print its send/receive ports</strong> when executed. You can then control remotely the Faust DSP parameters by sending OSC messages like so:</p>
<ul>
<li><em>/virtualAnalog/lfoRange 2000</em></li>
<li><em>/virtualAnalog/oscFreq 500</em></li>
<li>...</li>
</ul>
<p>More on: https://faustdoc.grame.fr/manual/osc/</p>
<h3 id="midi-control">MIDI control</h3>
<p>In order to build a target with <strong>MIDI support</strong>, you can add the <code>--midi</code> flag to the command line:</p>
<pre><code class="language-shell">syfala examples/fm.dsp --linux --midi
</code></pre>
<p><strong>Note:</strong> your Faust <strong>.dsp file must also contain this line</strong> in order to enable MIDI support:</p>
<pre><code class="language-faust">declare options &quot;[midi:on]&quot;;
</code></pre>
<p>The <strong>Zybo boards</strong> have a <strong>Host USB port</strong>, located next to the switches. It can be used to <strong>connect a MIDI  device</strong> and map its controls accordingly. No additional driver configuration is needed, <strong>but the board needs to be powered from an external power supply source</strong>:</p>
<blockquote>
<p>The supply must use a center-positive 2.1mm internal-diameter plug and deliver between 4.5V to 5.5V DC. It should also be able to output at least 2.5 A (12.5 Watts) in order to support power-hungry Zynq projects and external peripherals. To use an external supply with a barrel jack, plug it into the power jack (J17), set jumper JP6 to “WALL”, and then set SW4 to “ON”. </p>
</blockquote>
<p>You'll also have to put a <strong>shorting jumper</strong> on <strong>JP2</strong> (<em>HOST</em>), next to the USB port.</p>
<p>The <strong>Faust midi-mapping process</strong> is explained here: https://faustdoc.grame.fr/manual/midi/</p>
<h3 id="wi-fi">Wi-Fi</h3>
<p>Wi-Fi is handled by <em>iwd</em> (provided you have an USB dongle, or the appropriate additional hardware, which Zybo boards do not possess natively), the available commands are: </p>
<pre><code class="language-shell"># List your available wifi device(s), look for wlan0
iwctl device list
# If you don't know the SSID of your network, you can run a scan and retrieve a list of all the detected networks:
iwctl station wlan0 scan &amp;&amp; iwctl station wlan0 get-networks
# To connect to a network (use connect-hidden if it is a private network):
iwctl station wlan0 connect &lt;SSID&gt;
</code></pre>
<p>more on: https://wiki.alpinelinux.org/wiki/Wi-Fi</p>
<h3 id="autologin-autostart-dsp-target">Autologin / Autostart DSP target</h3>
<p>In order to <strong>autologin</strong> as root on the board, you have to edit the file <em>/etc/inittab</em> like the following:</p>
<pre><code class="language-shell">#ttyPS0::respawn:/sbin/getty -L ttyPS0 115200 vt100
# For autologin (as root): comment out the previous line and uncomment the next one:
ttyPS0::respawn:/sbin/mingetty --autologin root --noclear ttyPS0 115200 vt100
</code></pre>
<p>To <strong>autostart a DSP target on boot</strong>, create a <em>.start</em> file in <em>/etc/local.d</em> , for example <em>/etc/local.d/virtualAnalog.start</em>:</p>
<pre><code class="language-shell">#!/bin/sh
syfala-load virtualAnalog
</code></pre>
<p>Execute <code>chmod 755 /etc/local.d/virtualAnalog</code> . That's it!</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2023 <a href="https://team.inria.fr/emeraude/">Emeraude</a></p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
